<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Yahoo!カーナビ リンク生成ツール</title>
    <script src="https://cdn.jsdelivr.net/npm/open-location-code@1.0.3/openlocationcode.min.js"></script>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; background-color: #f0f2f5; color: #1c1e21; margin: 0; padding: 20px; display: flex; justify-content: center; }
        .container { max-width: 600px; width: 100%; background-color: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1); }
        h1 { font-size: 24px; text-align: center; margin-bottom: 20px; }
        label { font-weight: bold; font-size: 16px; display: block; margin-bottom: 5px; }
        input[type="text"], textarea { width: calc(100% - 22px); padding: 10px; border: 1px solid #dddfe2; border-radius: 6px; font-size: 16px; margin-bottom: 15px; }
        button { width: 100%; padding: 12px; background-color: #007bff; color: white; border: none; border-radius: 6px; font-size: 18px; font-weight: bold; cursor: pointer; }
        #result { margin-top: 20px; }
        #result_label { font-weight: bold; margin-bottom: 5px; display: block; }
        #result_link { width: 100%; box-sizing: border-box; padding: 8px; font-size: 14px; border: 1px solid #ccc; border-radius: 4px; background-color: #f8f8f8; }
        .ref-point { border: 1px solid #007bff; border-radius: 8px; padding: 10px; margin-top: 15px; background-color: #f0f8ff; }
        .ref-point label { font-weight: bold; font-size: 14px; display: block; margin-bottom: 5px; }
        .ref-point input { width: calc(50% - 15px); padding: 8px; border: 1px solid #ccc; border-radius: 4px; }
        .action-buttons { display: flex; gap: 10px; margin-top: 10px; }
        .action-buttons button { font-size: 16px; padding: 10px; background-color: #28a745; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Yahoo!カーナビ<br>リンク生成ツール</h1>

        <div id="form-group">
            <label for="destination">目的地 (必須)</label>
            <input type="text" id="destination" placeholder="リンク、Plus Code、または住所を入力">

            <label for="waypoints">経由地 (任意、3つまで)</label>
            <textarea id="waypoints" rows="3" placeholder="1行に1つずつ入力"></textarea>
        </div>
        <div class="ref-point">
            <label for="refLat">ショートコード用の基準点 (任意)</label>
            <input type="text" id="refLat" placeholder="基準点の緯度 (例: 35.68)">
            <input type="text" id="refLon" placeholder="基準点の経度 (例: 139.76)">
        </div>

        <button onclick="generateLink()" style="margin-top: 15px;">ナビゲーションリンクを生成</button>

        <div id="result" style="display: none;">
            <label id="result_label" for="result_link">生成されたリンク：</label>
            <textarea id="result_link" readonly></textarea>
            <div class="action-buttons">
                <button id="copyButton">リンクをコピー</button>
                <button id="shareButton" style="display: none;">共有する</button>
            </div>
        </div>
    </div>

    <script>
        function parseLocation(line, refLat, refLon) {
            line = line.trim();
            if (!line) return null;

            // GoogleマップのURL
            const gmapMatch = line.match(/@(-?\d+\.\d+),(-?\d+\.\d+)/);
            if (gmapMatch) {
                return { lat: gmapMatch[1], lon: gmapMatch[2] };
            }

            // Plus Code
            try {
                if (OpenLocationCode.isFull(line)) {
                    const decoded = OpenLocationCode.decode(line);
                    return { lat: decoded.latitudeCenter, lon: decoded.longitudeCenter };
                }
                const shortCodeMatch = line.match(/^[2-9CFGHJMPQRVWX]{4,}\+[2-9CFGHJMPQRVWX]{2,}/);
                if (shortCodeMatch) {
                    const shortCode = shortCodeMatch[0];
                    if (isNaN(refLat) || isNaN(refLon)) {
                        alert("ショートコード「" + shortCode + "」を変換するには、有効な基準点の緯度と経度を入力してください。");
                        return 'error'; // エラーを明確に識別
                    }
                    const recovered = OpenLocationCode.recoverNearest(shortCode, refLat, refLon);
                    const decoded = OpenLocationCode.decode(recovered);
                    return { lat: decoded.latitudeCenter, lon: decoded.longitudeCenter };
                }
            } catch (e) {
                return null;
            }
            
            // 上記のどれでもない場合は、ジオコーディングAPIが必要な住所文字列と見なす
            // 今回は未対応なのでエラーとする
            alert("「" + line + "」は解析できない形式です。GoogleマップのリンクかPlus Codeを入力してください。");
            return 'error';
        }

        function generateLink() {
            const destinationText = document.getElementById('destination').value.trim();
            const waypointsText = document.getElementById('waypoints').value.trim();
            const refLat = parseFloat(document.getElementById('refLat').value);
            const refLon = parseFloat(document.getElementById('refLon').value);
            
            if (!destinationText) {
                alert("目的地を必ず入力してください。");
                return;
            }

            // 経由地と目的地を一つの配列にまとめる（目的地が最後）
            const waypointLines = waypointsText ? waypointsText.split('\n').filter(line => line.trim() !== '') : [];
            const allLocationLines = [...waypointLines, destinationText];
            
            let coords = [];
            for (const line of allLocationLines) {
                const result = parseLocation(line, refLat, refLon);
                if (result === 'error') return; // 解析エラーが出たら中断
                if (result) coords.push(result);
            }

            if (coords.length !== allLocationLines.length) {
                // このケースはparseLocation内のアラートで処理される
                return;
            }
            
            let yahooNaviUrl = "yjcarnavi://navi/select?point=current";
            coords.forEach(coord => {
                yahooNaviUrl += `&point=${coord.lat},${coord.lon}`;
            });

            // 結果表示と共有ボタンのロジック (変更なし)
            const resultDiv = document.getElementById('result');
            const resultLinkTextarea = document.getElementById('result_link');
            resultLinkTextarea.value = yahooNaviUrl;
            resultDiv.style.display = 'block';
            const copyButton = document.getElementById('copyButton');
            copyButton.textContent = 'リンクをコピー';
            copyButton.onclick = function() {
                navigator.clipboard.writeText(yahooNaviUrl).then(() => {
                    copyButton.textContent = 'コピーしました！';
                    setTimeout(() => { copyButton.textContent = 'リンクをコピー'; }, 2000);
                }, () => { alert('コピーに失敗しました。'); });
            };
            const shareButton = document.getElementById('shareButton');
            if (navigator.share) {
                shareButton.style.display = 'block';
                shareButton.onclick = function() {
                    navigator.share({ title: 'Yahoo!カーナビ 経路リンク', text: yahooNaviUrl })
                    .catch(error => console.log('共有がキャンセルされました', error));
                };
            } else {
                shareButton.style.display = 'none';
            }
        }
    </script>
</body>
</html>


