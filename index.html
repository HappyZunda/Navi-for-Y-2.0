<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Yahoo!カーナビ リンク生成ツール</title>
    <script src="https://cdn.jsdelivr.net/npm/open-location-code@1.0.3/openlocationcode.min.js"></script>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; background-color: #f0f2f5; color: #1c1e21; margin: 0; padding: 20px; display: flex; justify-content: center; }
        .container { max-width: 600px; width: 100%; background-color: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1); }
        h1 { font-size: 24px; text-align: center; margin-bottom: 20px; }
        label { font-weight: bold; font-size: 16px; display: block; margin-bottom: 5px; }
        input[type="text"], textarea { width: calc(100% - 22px); padding: 10px; border: 1px solid #dddfe2; border-radius: 6px; font-size: 16px; margin-bottom: 15px; }
        #result { margin-top: 20px; }
        #result_label { font-weight: bold; margin-bottom: 5px; display: block; }
        #result_link { width: 100%; box-sizing: border-box; padding: 8px; font-size: 14px; border: 1px solid #ccc; border-radius: 4px; background-color: #f8f8f8; }
        .memo-field { margin-top: 15px; }
        
        .main-actions { display: flex; gap: 10px; margin-top: 15px; }
        .main-actions button { flex: 1; padding: 12px; color: white; border: none; border-radius: 6px; font-size: 18px; font-weight: bold; cursor: pointer; transition: opacity 0.2s; }
        .main-actions button:hover { opacity: 0.9; }
        .generate-button { background-color: #0d6efd; }
        .reset-button { background-color: #6c757d; }

        #launchButton { display: block; width: 100%; box-sizing: border-box; margin-top: 10px; padding: 12px; border-radius: 6px; background-color: #0d6efd; color: white; text-decoration: none; text-align: center; font-size: 18px; font-weight: bold; transition: opacity 0.2s; }
        #launchButton:hover { opacity: 0.9; }
        .secondary-actions { display: flex; gap: 10px; margin-top: 10px; }
        .secondary-actions button { flex: 1; padding: 10px; font-size: 16px; border-radius: 6px; border: none; cursor: pointer; transition: opacity 0.2s; }
        .secondary-actions button:hover { opacity: 0.9; }
        .copy { background-color: #0dcaf0; color: #000; }
        .share { background-color: #198754; color: white; }

        /* --- ここからが新しい説明文のスタイルです --- */
        .rules-box {
            background-color: #e9f5ff;
            border: 1px solid #b3d7ff;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            font-size: 14px;
        }
        .rules-box h4 {
            margin-top: 0;
            margin-bottom: 10px;
            color: #0056b3;
        }
        .rules-box ul {
            margin: 0;
            padding-left: 20px;
        }
        .rules-box li {
            margin-bottom: 5px;
        }
        /* --- ここまでが新しい説明文のスタイルです --- */

    </style>
</head>
<body>
    <div class="container">
        <h1>Yahoo!カーナビ<br>リンク生成ツール</h1>

        <div class="rules-box">
            <h4>💡 入力のヒント</h4>
            <ul>
                <li><strong>Googleマップリンク:</strong> URLに緯度経度（例: <code>@35.6,139.7</code>）が含まれる形式にのみ対応しています。</li>
                <li><strong>短縮URL:</strong> <code>goo.gl/maps/</code> 等の短いリンクは、一度ブラウザで開いてから、表示された長いURLをコピーして貼り付けてください。</li>
                <li><strong>Plus Code:</strong> <code>8Q7XMP56+3H</code> のような、地名を含まない「フルコード」形式で入力してください。</li>
            </ul>
        </div>
        <div id="form-group">
            <label for="destination">目的地 (必須)</label>
            <input type="text" id="destination" placeholder="リンク または Plus Code (フルコード)">

            <label for="waypoints">経由地 (任意、3つまで)</label>
            <textarea id="waypoints" rows="3" placeholder="1行に1つずつ入力"></textarea>
        </div>
        
        <div class="main-actions">
            <button class="reset-button" onclick="resetForm()">リセット</button>
            <button class="generate-button" onclick="generateLink()">リンクを生成</button>
        </div>

        <div id="result" style="display: none;">
            <label id="result_label" for="result_link">生成されたリンク：</label>
            <textarea id="result_link" readonly></textarea>
            
            <div class="memo-field">
                <label for="shareMemo">共有メモ (任意)</label>
                <input type="text" id="shareMemo" placeholder="例：〇〇時に集合！">
            </div>

            <a id="launchButton" href="#" style="display: none;">アプリを起動</a>
            <div class="secondary-actions">
                <button id="copyButton" class="copy">リンクをコピー</button>
                <button id="shareButton" class="share" style="display: none;">共有する</button>
            </div>
        </div>
    </div>

    <script>
        // JavaScript部分は変更ありません
        function resetForm() {
            document.getElementById('destination').value = '';
            document.getElementById('waypoints').value = '';
            document.getElementById('shareMemo').value = '';
            document.getElementById('result').style.display = 'none';
        }

        function parseLocation(line) {
            line = line.trim();
            if (!line) return null;
            const gmapMatch = line.match(/@(-?\d+\.\d+),(-?\d+\.\d+)/);
            if (gmapMatch) { return { lat: gmapMatch[1], lon: gmapMatch[2] }; }
            try {
                if (OpenLocationCode.isFull(line)) {
                    const decoded = OpenLocationCode.decode(line);
                    return { lat: decoded.latitudeCenter, lon: decoded.longitudeCenter };
                }
            } catch (e) { return null; }
            alert("「" + line + "」は解析できない形式です。Googleマップのリンクか、Plus Codeのフルコードを入力してください。");
            return 'error';
        }

        function generateLink() {
            const destinationText = document.getElementById('destination').value.trim();
            const waypointsText = document.getElementById('waypoints').value.trim();
            if (!destinationText) { alert("目的地を必ず入力してください。"); return; }
            const waypointLines = waypointsText ? waypointsText.split('\n').filter(line => line.trim() !== '') : [];
            const allLocationLines = [...waypointLines, destinationText];
            let coords = [];
            for (const line of allLocationLines) {
                const result = parseLocation(line);
                if (result === 'error') return;
                if (result) coords.push(result);
            }
            if (coords.length !== allLocationLines.length) return;
            let yahooNaviUrl = "yjcarnavi://navi/select?point=current";
            coords.forEach(coord => { yahooNaviUrl += `&point=${coord.lat},${coord.lon}`; });

            const resultDiv = document.getElementById('result');
            const resultLinkTextarea = document.getElementById('result_link');
            resultLinkTextarea.value = yahooNaviUrl;
            resultDiv.style.display = 'block';
            
            const launchButton = document.getElementById('launchButton');
            launchButton.href = yahooNaviUrl;
            launchButton.style.display = 'block';

            const copyButton = document.getElementById('copyButton');
            copyButton.textContent = 'リンクをコピー';
            copyButton.onclick = function() {
                const shareMemo = document.getElementById('shareMemo').value.trim();
                let textToCopy = yahooNaviUrl;
                if (shareMemo) {
                    textToCopy = shareMemo + '\n' + yahooNaviUrl;
                }
                navigator.clipboard.writeText(textToCopy).then(() => {
                    copyButton.textContent = 'コピーしました！';
                    setTimeout(() => { copyButton.textContent = 'リンクをコピー'; }, 2000);
                }, () => { alert('コピーに失敗しました。'); });
            };
            
            const shareButton = document.getElementById('shareButton');
            if (navigator.share) {
                shareButton.style.display = 'block';
                shareButton.onclick = function() {
                    const shareMemo = document.getElementById('shareMemo').value.trim();
                    let shareText = yahooNaviUrl;
                    if (shareMemo) {
                        shareText = shareMemo + '\n' + yahooNaviUrl;
                    }
                    navigator.share({
                        title: 'Yahoo!カーナビ 経路リンク',
                        text: shareText,
                    })
                    .catch(error => console.log('共有がキャンセルされました', error));
                };
            } else {
                shareButton.style.display = 'none';
            }
        }
    </script>
</body>
</html>
